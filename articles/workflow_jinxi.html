<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workflow: Jinxi • urbanAnnualRunoff</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Workflow: Jinxi">
<meta property="og:description" content="urbanAnnualRunoff">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">urbanAnnualRunoff</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/workflow_beijing.html">Workflow: Beijing</a>
    </li>
    <li>
      <a href="../articles/workflow_jinxi.html">Workflow: Jinxi</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/KWB-R/urbanAnnualRunoff/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="workflow_jinxi_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="workflow_jinxi_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="workflow_jinxi_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Workflow: Jinxi</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/KWB-R/urbanAnnualRunoff/blob/master/vignettes/workflow_jinxi.Rmd"><code>vignettes/workflow_jinxi.Rmd</code></a></small>
      <div class="hidden name"><code>workflow_jinxi.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">### prerequisites (64bit R)</span>
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"R_ARCH"</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"/x64"</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Spatial operations need a lot of RAM. Use of 64bit R is required. 
  
Workflow in RStudio:  
1. Go to 'Tools' (top pane)
2. Select 'Global Options' 
3. Select 'General' 
4. Under 'R Sessions' select 'Change' 
5. Select 'Use the machine`s default R version of R64 (64-bit)'
6. Close all R Studio sessions  
7. Restart R Studio"</span>
<span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>


<span class="va">path_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  root_path <span class="op">=</span> <span class="st">"C:/kwb/projects/keys/Data-Work packages"</span>,
  site <span class="op">=</span> <span class="st">"Jinxi"</span>,
  data <span class="op">=</span> <span class="st">"WP2_SUW_pollution_&lt;site&gt;"</span>,
  abimo <span class="op">=</span> <span class="st">"&lt;root_path&gt;/&lt;data&gt;/_DataAnalysis/abimo"</span>,
  abimo_exe <span class="op">=</span> <span class="st">"&lt;abimo&gt;/Abimo3_2.exe"</span>,
  gis <span class="op">=</span> <span class="st">"&lt;root_path&gt;/&lt;data&gt;/_DataAnalysis/gis"</span>,
  climate <span class="op">=</span> <span class="st">"&lt;root_path&gt;/&lt;data&gt;/_DataAnalysis/climate"</span>
<span class="op">)</span>

<span class="va">paths</span> <span class="op">&lt;-</span> <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/resolve.html">resolve</a></span><span class="op">(</span><span class="va">path_list</span><span class="op">)</span>

<span class="co"># load shapefile containing subcatchments ('blockteilflächen')</span>
<span class="va">abimo</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/shapefile.html">shapefile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">gis</span>, <span class="st">'input_subareas.shp'</span><span class="op">)</span><span class="op">)</span>

<span class="co"># make ABIMO 'CODE' column</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"CODE"</span> 

<span class="co"># pad CODE with zeroes to match output of ABIMO</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">CODE</span> <span class="op">&lt;-</span> <span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/padCODE.html">padCODE</a></span><span class="op">(</span><span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">CODE</span><span class="op">)</span>

<span class="co"># build classification model</span>
<span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/buildClassMod.html">buildClassMod</a></span><span class="op">(</span>
  rawdir <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">gis</span>,
  image <span class="op">=</span> <span class="st">'input_image.img'</span>,
  groundTruth <span class="op">=</span> <span class="st">'input_groundtruth.shp'</span>,
  groundTruthValues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'roof'</span> <span class="op">=</span> <span class="fl">1</span>, 
                           <span class="st">'street'</span> <span class="op">=</span> <span class="fl">2</span>,
                           <span class="st">'pervious'</span> <span class="op">=</span> <span class="fl">3</span>,
                           <span class="st">'shadow'</span> <span class="op">=</span> <span class="fl">4</span>,
                           <span class="st">'water'</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,
  spectrSigName <span class="op">=</span> <span class="st">'spectrSig.Rdata'</span>,
  modelName <span class="op">=</span> <span class="st">'rForest.Rdata'</span>,
  overlayExists <span class="op">=</span> <span class="cn">FALSE</span>,
  nCores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,
  mtryGrd <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, 
  ntreeGrd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">150</span>, by<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,
  nfolds <span class="op">=</span> <span class="fl">3</span>, 
  nodesize <span class="op">=</span> <span class="fl">3</span>, 
  cvrepeats <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="co"># check model performance</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">gis</span>,<span class="st">"rForest.Rdata"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">finalModel</span><span class="op">$</span><span class="va">predicted</span>, 
                       reference <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">trainingData</span><span class="op">$</span><span class="va">.outcome</span>, 
                       mode <span class="op">=</span> <span class="st">'prec_recall'</span><span class="op">)</span>
                       
<span class="co"># classify image for roofs and streets</span>
<span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/predictSurfClass.html">predictSurfClass</a></span><span class="op">(</span>rawdir <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">gis</span>,
                                    modelName <span class="op">=</span> <span class="st">'rForest.Rdata'</span>,
                                    image <span class="op">=</span> <span class="st">'input_image.img'</span>,
                                    predName <span class="op">=</span> <span class="st">'classified_image.img'</span><span class="op">)</span>

<span class="co"># make overlay object (list where each element is a vector of the pixel values </span>
<span class="co"># of the classified image for each subcatchment)</span>
<span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/makeOverlay.html">makeOverlay</a></span><span class="op">(</span>rawdir <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">gis</span>,
                               rasterData <span class="op">=</span> <span class="st">'classified_image.img'</span>,
                               subcatchmSPobject <span class="op">=</span> <span class="va">abimo</span>,
                               overlayName <span class="op">=</span> <span class="st">'surfType'</span><span class="op">)</span>
<span class="co"># make ABIMO variable FLGES</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">FLGES</span> <span class="op">&lt;-</span> <span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/makeFLGES.html">makeFLGES</a></span><span class="op">(</span>subcatchmSPobject <span class="op">=</span> <span class="va">abimo</span><span class="op">)</span>

<span class="co"># compute ABIMO variable PROBAU (%roof)</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">PROBAU</span> <span class="op">&lt;-</span> <span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/makePROBAU.html">makePROBAU</a></span><span class="op">(</span>
  rawdir <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">gis</span>,
  rasterData <span class="op">=</span> <span class="st">'classified_image.img'</span>,
  overlayName <span class="op">=</span> <span class="st">'surfType'</span>,
  targetValue <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  
<span class="co"># compute ABIMO variable STR_FLGES (m2 street area)</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">STR_FLGES</span> <span class="op">&lt;-</span> <span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/makeSTR_FLGES.html">makeSTR_FLGES</a></span><span class="op">(</span>
  rawdir <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">gis</span>,
  subcatchmSPobject <span class="op">=</span> <span class="va">abimo</span>,
  mask <span class="op">=</span> <span class="st">'input_maskUrbanCore.shp'</span>,
  rasterData <span class="op">=</span> <span class="st">'classified_image.img'</span>,
  overlayName <span class="op">=</span> <span class="st">'surfType'</span>,
  targetValue <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="co"># compute ABIMO variable VG (% soil sealing)</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">VG</span> <span class="op">&lt;-</span> <span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/makeVG.html">makeVG</a></span><span class="op">(</span>
  rawdir <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">gis</span>,
  subcatchmSPobject <span class="op">=</span> <span class="va">abimo</span>,
  rasterData <span class="op">=</span> <span class="st">'input_impervious.tif'</span>,
  targetValue <span class="op">=</span> <span class="fl">80</span><span class="op">)</span>

<span class="co"># compute annual and summer rainfall. </span>
<span class="co"># *** potential enhancement: ***</span>
<span class="co"># return the multiannual average annual rainfall. care must be taken to exclude</span>
<span class="co"># incomplete years from the average calculation. same for summer rainfall</span>
<span class="va">precipitation</span> <span class="op">&lt;-</span> <span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/computeABIMOclimate.html">computeABIMOclimate</a></span><span class="op">(</span>
  rawdir <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">climate</span>,
  fileName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">'raw_climateeng_precipitation_daily_%s.txt'</span>, 
                     <span class="va">paths</span><span class="op">$</span><span class="va">site</span><span class="op">)</span>,
  skip <span class="op">=</span> <span class="fl">6</span>, sep <span class="op">=</span> <span class="st">''</span>, dec <span class="op">=</span> <span class="st">'.'</span>,
  outAnnual <span class="op">=</span> <span class="st">'precipitation_annual.txt'</span>,
  outSummer <span class="op">=</span><span class="st">'precipitation_summer.txt'</span><span class="op">)</span>
<span class="co"># compute annual and summer ETP. this goes manually into the ABIMO config file</span>
  <span class="va">evapotranspiration</span> <span class="op">&lt;-</span> <span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/computeABIMOclimate.html">computeABIMOclimate</a></span><span class="op">(</span>rawdir <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">climate</span>,
                    fileName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">'raw_climateeng_etp_daily_%s.txt'</span>, 
                                       <span class="va">paths</span><span class="op">$</span><span class="va">site</span><span class="op">)</span>,
                    skip <span class="op">=</span> <span class="fl">6</span>, sep <span class="op">=</span> <span class="st">''</span>, dec <span class="op">=</span> <span class="st">'.'</span>,
                    outAnnual <span class="op">=</span> <span class="st">'etp_annual.txt'</span>,
                    outSummer <span class="op">=</span> <span class="st">'etp_summer.txt'</span><span class="op">)</span>

<span class="co"># use raw code to compute and assign remaining ABIMO variables manually</span>
<span class="co"># raw code ------------------------------------------------------------------------------</span>

<span class="co"># raw code ------------------------------------------------------------------------------</span>

<span class="co"># compute ABIMO variable PROVGU (% other impervious areas) as </span>
<span class="co"># PROVGU = VG - PROBAU, setting any negative values to 0. this</span>
<span class="co"># happens for only &lt;10% of subcatchments, and results mainly from</span>
<span class="co"># differences in spatial resolution and classification differences</span>
<span class="co"># between both datasets (our classified image and the global land </span>
<span class="co"># use dataset)</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">PROVGU</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">(</span><span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">VG</span> <span class="op">-</span> <span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">PROBAU</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>,
                            <span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">VG</span> <span class="op">-</span> <span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">PROBAU</span>,
                            <span class="fl">0</span><span class="op">)</span>

<span class="co"># % imperviousness streets</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">VGSTRASSE</span> <span class="op">&lt;-</span> <span class="fl">100</span>

<span class="co"># %cover types in other imperv. areas (PROVGU)</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">BELAG1</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">BELAG2</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">BELAG3</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">BELAG4</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="co"># %cover types in street areas</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">STR_BELAG1</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">STR_BELAG2</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">STR_BELAG3</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">STR_BELAG4</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="co"># identifiers</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">BEZIRK</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">STAGEB</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">BLOCK</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">TEILBLOCK</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">NUTZUNG</span> <span class="op">&lt;-</span> <span class="fl">21</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">TYP</span> <span class="op">&lt;-</span> <span class="fl">21</span>


<span class="co"># annual rainfall (this can be automatized by making 'computeABIMOclimate'</span>
<span class="co"># return the multiannual average annual rainfall. care must be taken to exclude</span>
<span class="co"># incomplete years from the average calculation)</span>

<span class="co"># manually averaged annual rainfall and summer rainfall</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">REGENJA</span> <span class="op">&lt;-</span> <span class="fl">1744</span> <span class="co"># averaged manually</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">REGENSO</span> <span class="op">&lt;-</span> <span class="fl">1258</span> <span class="co"># averaged manually</span>
  
<span class="co"># better version using dplyr</span>
<span class="co">#year_min &lt;- 2015</span>
<span class="co">#year_max &lt;- 2019</span>
<span class="co">#abimo@data$REGENJA &lt;- precipitation$total %&gt;% </span>
<span class="co">#  dplyr::filter(.data$year &gt;= year_min &amp; .data$year &lt;= year_max) %&gt;% </span>
<span class="co">#  dplyr::summarise(value_mean = mean(.data$value)) %&gt;% </span>
<span class="co">#  dplyr::pull()</span>
<span class="co">#abimo@data$REGENSO &lt;- precipitation$summer %&gt;% </span>
<span class="co">#  dplyr::filter(.data$year &gt;= year_min &amp; .data$year &lt;= year_max) %&gt;% </span>
<span class="co">#  dplyr::summarise(value_mean = mean(.data$value)) %&gt;%  </span>
<span class="co">#  dplyr::pull()</span>

<span class="co">### calculate mean evapotranspiration (total, summer) to be defined as input </span>
<span class="co">### in ABIMO "config.xml" file</span>
<span class="co"># ept_mean &lt;- tibble::tibble(total = evapotranspiration$total %&gt;% </span>
<span class="co">#   dplyr::filter(.data$year &gt;= year_min &amp; .data$year &lt;= year_max) %&gt;% </span>
<span class="co">#   dplyr::summarise(value_mean = mean(value)) %&gt;% </span>
<span class="co">#   as.numeric(), </span>
<span class="co">#   summer = evapotranspiration$summer %&gt;% </span>
<span class="co">#   dplyr::filter(.data$year &gt;= year_min &amp; .data$year &lt;= year_max) %&gt;% </span>
<span class="co">#   dplyr::summarise(value_mean = mean(.data$value)) %&gt;% </span>
<span class="co">#   as.numeric())</span>
<span class="co">#   </span>
<span class="co">#   </span>
<span class="co"># abimo_config &lt;- file.path(paths$abimo, "config.xml")</span>
<span class="co"># </span>
<span class="co"># message(sprintf("Manually set values in ABIMO config file:</span>
<span class="co"># '%s'</span>
<span class="co"># </span>
<span class="co"># In '&lt;section name=\"PotentielleVerdunstung\"&gt;\"' </span>
<span class="co"># </span>
<span class="co"># Enter the following values for for 'BEZIRK = 1' and also default 'BEZIRK = 0'</span>
<span class="co"># etp: %4.0f</span>
<span class="co"># etps: %4.1f",</span>
<span class="co">#                 abimo_config,</span>
<span class="co">#                 ept_mean$total, </span>
<span class="co">#                 ept_mean$summer))</span>
<span class="co"># ### open ABIMO config for manual data input</span>
<span class="co"># kwb.utils::hsOpenWindowsExplorer(abimo_config)</span>

  
<span class="co">#abimo_config &lt;- file.path(paths$abimo, "config.xml")</span>

<span class="co">#message(sprintf("Manually set values in ABIMO config file:</span>
<span class="st">'%s'</span>

<span class="co">#In '&lt;section name=\"PotentielleVerdunstung\"&gt;\"' </span>

<span class="co">#Enter the following values for for 'BEZIRK = 1' and also default 'BEZIRK = 0'</span>
<span class="co">#etp: %4.0f</span>
<span class="co">#etps: %4.1f",</span>
<span class="co">#                abimo_config,</span>
<span class="co">#                ept_mean$total, </span>
<span class="co">#                ept_mean$summer))</span>
<span class="co">### open ABIMO config for manual data input</span>
<span class="co">#kwb.utils::hsOpenWindowsExplorer(abimo_config)</span>

<span class="co"># channelization degrees. these are set manually since there is no data</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">KANAL</span><span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">KAN_BEB</span><span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">KAN_VGU</span><span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">KAN_STR</span><span class="op">&lt;-</span> <span class="fl">100</span>

<span class="co"># soil field capacity and groundwater level (personal communication, Dr. Lipin Li, </span>
<span class="co"># Harbin Inst. of Technology)</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">FELD_30</span> <span class="op">&lt;-</span> <span class="fl">30</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">FELD_150</span> <span class="op">&lt;-</span> <span class="fl">30</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">FLUR</span> <span class="op">&lt;-</span> <span class="fl">1.17</span>

<span class="co"># select required columns and write out new shapefile</span>
<span class="va">requiredCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'CODE'</span>, <span class="st">'BEZIRK'</span>, <span class="st">'STAGEB'</span>, <span class="st">'BLOCK'</span>, <span class="st">'TEILBLOCK'</span>,
                  <span class="st">'NUTZUNG'</span>, <span class="st">'TYP'</span>,
                  <span class="st">'FLGES'</span>, <span class="st">'STR_FLGES'</span>,
                  <span class="st">'PROBAU'</span>, <span class="st">'PROVGU'</span>, <span class="st">'VGSTRASSE'</span>,
                  <span class="st">'BELAG1'</span>, <span class="st">'BELAG2'</span>, <span class="st">'BELAG3'</span>, <span class="st">'BELAG4'</span>,
                  <span class="st">'STR_BELAG1'</span>, <span class="st">'STR_BELAG2'</span>, <span class="st">'STR_BELAG3'</span>, <span class="st">'STR_BELAG4'</span>,
                  <span class="st">'KAN_BEB'</span>, <span class="st">'KAN_VGU'</span>, <span class="st">'KAN_STR'</span>,
                  <span class="st">'REGENJA'</span>, <span class="st">'REGENSO'</span>,
                  <span class="st">'FELD_30'</span>, <span class="st">'FELD_150'</span>, <span class="st">'FLUR'</span><span class="op">)</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>, <span class="va">requiredCols</span><span class="op">]</span>

<span class="co"># format numbers to 0 decimal places</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>, <span class="fl">8</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span>
  <span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>, <span class="fl">8</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">abimo</span><span class="op">@</span><span class="va">data</span><span class="op">)</span><span class="op">]</span>,
  digits <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>

<span class="co"># change decimal separator to comma (ABIMO does not run correctly otherwise)</span>
<span class="va">abimo</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span>X<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">abimo</span><span class="op">@</span><span class="va">data</span>,
                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,
                                         FUN<span class="op">=</span><span class="va">as.character</span><span class="op">)</span>,
                                 <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,
                                 FUN<span class="op">=</span><span class="va">gsub</span>,
                                 pattern<span class="op">=</span><span class="st">"\\."</span>,
                                 replacement<span class="op">=</span><span class="st">","</span><span class="op">)</span>,
                           stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># write ABIMO input table</span>
<span class="va">abimo_inp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">'abimo_%s.shp'</span>, <span class="va">paths</span><span class="op">$</span><span class="va">site</span><span class="op">)</span>
<span class="va">abimo_inp_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">abimo</span>, <span class="va">abimo_inp</span><span class="op">)</span>
<span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/shapefile.html">shapefile</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">abimo</span>, 
                  filename<span class="op">=</span><span class="va">abimo_inp_path</span>,
                  overwrite<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>


<span class="co"># run ABIMO manually in GUI ----------------------------------------------------</span>
<span class="va">abimo_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">'abimo_%sout.dbf'</span>, <span class="va">paths</span><span class="op">$</span><span class="va">site</span><span class="op">)</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/file_access.html">file_exists</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">abimo_exe</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"ABIMO executale does not exist: %s
Please copy to this location"</span>, <span class="va">paths</span><span class="op">$</span><span class="va">abimo_exe</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Run ABIMO executable manually:
1. Select input file: \"%s\"
2. Save it under: \"%s\""</span>, 
                    <span class="va">abimo_inp_path</span>, 
                    <span class="va">abimo_out</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>
      
<span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/hsOpenWindowsExplorer.html">hsOpenWindowsExplorer</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">abimo_exe</span><span class="op">)</span>

<span class="co"># postprocessing ----------------------------------------------------------------</span>
<span class="co"># post-process ABIMO output file -&gt; join it with input shape file for </span>
<span class="co"># visualization in GIS</span>
<span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/postProcessABIMO.html">postProcessABIMO</a></span><span class="op">(</span>rawdir <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">abimo</span>,
                 nameABIMOin <span class="op">=</span> <span class="va">abimo_inp</span>,
                 nameABIMOout <span class="op">=</span> <span class="va">abimo_out</span>,
                 ABIMOjoinedName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%s_joined.dbf"</span>, <span class="va">abimo_out</span><span class="op">)</span>
                <span class="op">)</span>
<span class="op">}</span>

<span class="op">}</span></code></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/robetatis">Roberto Tatis-Muvdi</a>, <a href="https://mrustl.de">Michael Rustler</a>, <a href="https://www.kompetenz-wasser.de/en/project/keys/"><img src="https://www.kompetenz-wasser.de/wp-content/uploads/2018/09/keys-logo.png" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
