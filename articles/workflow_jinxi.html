<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="urbanAnnualRunoff">
<title>Workflow: Jinxi â€¢ urbanAnnualRunoff</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Workflow: Jinxi">
<meta property="og:description" content="urbanAnnualRunoff">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">urbanAnnualRunoff</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/workflow_beijing.html">Workflow: Beijing</a>
    <a class="dropdown-item" href="../articles/workflow_jinxi.html">Workflow: Jinxi</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/KWB-R/urbanAnnualRunoff/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="workflow_jinxi_files/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="workflow_jinxi_files/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="workflow_jinxi_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="workflow_jinxi_files/datatables-binding-0.23/datatables.js"></script><link href="workflow_jinxi_files/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="workflow_jinxi_files/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="workflow_jinxi_files/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="workflow_jinxi_files/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="workflow_jinxi_files/crosstalk-1.2.0/js/crosstalk.min.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Workflow: Jinxi</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/KWB-R/urbanAnnualRunoff/blob/HEAD/vignettes/workflow_jinxi.Rmd" class="external-link"><code>vignettes/workflow_jinxi.Rmd</code></a></small>
      <div class="d-none name"><code>workflow_jinxi.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">### prerequisites (64bit R)</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="cf">if</span>(<span class="kw">Sys.getenv</span>(<span class="st">"R_ARCH"</span>) <span class="op">!=</span><span class="st"> "/x64"</span>) {</span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="kw">stop</span>(<span class="st">"Spatial operations need a lot of RAM. Use of 64bit R is required. </span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="st">  </span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="st">Workflow in RStudio:  </span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="st">1. Go to 'Tools' (top pane)</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="st">2. Select 'Global Options' </span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="st">3. Select 'General' </span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="st">4. Under 'R Sessions' select 'Change' </span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="st">5. Select 'Use the machine`s default R version of R64 (64-bit)'</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="st">6. Close all R Studio sessions  </span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="st">7. Restart R Studio"</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>)</span>
<span id="cb1-14"><a href="#cb1-14"></a>} <span class="cf">else</span> {</span>
<span id="cb1-15"><a href="#cb1-15"></a>  </span>
<span id="cb1-16"><a href="#cb1-16"></a>path_list &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="dt">root_path =</span> <span class="st">"C:/kwb/projects/keys/Data-Work packages"</span>,</span>
<span id="cb1-18"><a href="#cb1-18"></a>  <span class="dt">site =</span> <span class="st">"Jinxi"</span>,</span>
<span id="cb1-19"><a href="#cb1-19"></a>  <span class="dt">data =</span> <span class="st">"WP2_SUW_pollution_&lt;site&gt;"</span>,</span>
<span id="cb1-20"><a href="#cb1-20"></a>  <span class="dt">data_hit =</span> <span class="st">"&lt;root_path&gt;/&lt;data&gt;/_DataHIT"</span>,</span>
<span id="cb1-21"><a href="#cb1-21"></a>  <span class="dt">abimo =</span> <span class="st">"&lt;root_path&gt;/&lt;data&gt;/_DataAnalysis/abimo"</span>,</span>
<span id="cb1-22"><a href="#cb1-22"></a>  <span class="dt">abimo_inp_shp =</span> <span class="st">"&lt;abimo&gt;/abimo_&lt;site&gt;.shp"</span>,</span>
<span id="cb1-23"><a href="#cb1-23"></a>  <span class="dt">abimo_inp_dbf =</span> <span class="st">"&lt;abimo&gt;/abimo_&lt;site&gt;.dbf"</span>,</span>
<span id="cb1-24"><a href="#cb1-24"></a>  <span class="dt">abimo_out =</span> <span class="st">"abimo_&lt;site&gt;out.dbf"</span>,</span>
<span id="cb1-25"><a href="#cb1-25"></a>  <span class="dt">abimo_berlin =</span> <span class="st">"&lt;abimo&gt;/abimo_2019_mitstrassen.dbf"</span>,</span>
<span id="cb1-26"><a href="#cb1-26"></a>  <span class="dt">abimo_scenarios =</span> <span class="st">"&lt;abimo&gt;/scenarios/de-coupling"</span>,</span>
<span id="cb1-27"><a href="#cb1-27"></a>  <span class="dt">abimo_config_original =</span> <span class="st">"&lt;abimo&gt;/config_original.xml"</span>,</span>
<span id="cb1-28"><a href="#cb1-28"></a>  <span class="dt">abimo_config_modified =</span> <span class="st">"&lt;abimo&gt;/config.xml"</span>,</span>
<span id="cb1-29"><a href="#cb1-29"></a>  <span class="dt">abimo_exe =</span> <span class="st">"&lt;abimo&gt;/Abimo3_2.exe"</span>,</span>
<span id="cb1-30"><a href="#cb1-30"></a>  <span class="dt">gis =</span> <span class="st">"&lt;root_path&gt;/&lt;data&gt;/_DataAnalysis/gis"</span>,</span>
<span id="cb1-31"><a href="#cb1-31"></a>  <span class="dt">climate =</span> <span class="st">"&lt;root_path&gt;/&lt;data&gt;/_DataAnalysis/climate"</span>,</span>
<span id="cb1-32"><a href="#cb1-32"></a>  <span class="dt">emissions_input =</span> <span class="st">"&lt;root_path&gt;/&lt;data&gt;/_DataAnalysis/emissions/input/annual_mean_conc.csv"</span>,</span>
<span id="cb1-33"><a href="#cb1-33"></a>  <span class="dt">emissions_output =</span> <span class="st">"&lt;root_path&gt;/&lt;data&gt;/_DataAnalysis/emissions/output"</span>,</span>
<span id="cb1-34"><a href="#cb1-34"></a>  <span class="dt">landuse_hit =</span> <span class="st">"&lt;gis&gt;/manual_processing/landuse_hit.dbf"</span>,</span>
<span id="cb1-35"><a href="#cb1-35"></a>  <span class="dt">landuse_kwb =</span> <span class="st">"&lt;gis&gt;/manual_processing/landuse_kwb.tif"</span>,</span>
<span id="cb1-36"><a href="#cb1-36"></a>  <span class="dt">catchments_hit_all =</span>  <span class="st">"&lt;gis&gt;/manual_processing/catchments_hit_all_area.dbf"</span>,</span>
<span id="cb1-37"><a href="#cb1-37"></a>  <span class="dt">catchments_hit_abimo =</span>  <span class="st">"&lt;gis&gt;/manual_processing/catchments_hit_abimo_area.dbf"</span>,</span>
<span id="cb1-38"><a href="#cb1-38"></a>  <span class="dt">landuse_authority =</span> <span class="st">"&lt;data_hit&gt;/2021-03-31_HIT_landuse-per-subcatchment/subcatchments_landuse_v1.0.0.xlsx"</span>,</span>
<span id="cb1-39"><a href="#cb1-39"></a>  <span class="dt">swmm_annualrunoff =</span> <span class="st">"&lt;data_hit&gt;/WP2_Data_HIT_20201023/swmm_annual_runoff_v1.0.0.txt"</span>,</span>
<span id="cb1-40"><a href="#cb1-40"></a>  <span class="dt">sewer_connection =</span> <span class="st">"&lt;data_hit&gt;/2021-10-18_email/cleaned/subcatchments_sewer-connection.xls"</span></span>
<span id="cb1-41"><a href="#cb1-41"></a>)</span>
<span id="cb1-42"><a href="#cb1-42"></a></span>
<span id="cb1-43"><a href="#cb1-43"></a>paths &lt;-<span class="st"> </span>kwb.utils<span class="op">::</span><span class="kw">resolve</span>(path_list)</span>
<span id="cb1-44"><a href="#cb1-44"></a></span>
<span id="cb1-45"><a href="#cb1-45"></a></span>
<span id="cb1-46"><a href="#cb1-46"></a><span class="co"># load shapefile containing subcatchments ('blockteilflÃ¤chen')</span></span>
<span id="cb1-47"><a href="#cb1-47"></a>abimo_org &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">shapefile</span>(<span class="kw">file.path</span>(paths<span class="op">$</span>gis, <span class="st">'input_subareas.shp'</span>))</span>
<span id="cb1-48"><a href="#cb1-48"></a></span>
<span id="cb1-49"><a href="#cb1-49"></a><span class="co"># make ABIMO 'CODE' column</span></span>
<span id="cb1-50"><a href="#cb1-50"></a><span class="kw">names</span>(abimo_org<span class="op">@</span>data) &lt;-<span class="st"> "CODE"</span> </span>
<span id="cb1-51"><a href="#cb1-51"></a></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="co"># pad CODE with zeroes to match output of ABIMO</span></span>
<span id="cb1-53"><a href="#cb1-53"></a>abimo_org<span class="op">@</span>data<span class="op">$</span>CODE &lt;-<span class="st"> </span>urbanAnnualRunoff<span class="op">::</span><span class="kw">padCODE</span>(abimo_org<span class="op">@</span>data<span class="op">$</span>CODE)</span>
<span id="cb1-54"><a href="#cb1-54"></a></span>
<span id="cb1-55"><a href="#cb1-55"></a><span class="co"># build classification model</span></span>
<span id="cb1-56"><a href="#cb1-56"></a>kwb.ml<span class="op">::</span><span class="kw">buildClassMod</span>(</span>
<span id="cb1-57"><a href="#cb1-57"></a>  <span class="dt">rawdir =</span> paths<span class="op">$</span>gis,</span>
<span id="cb1-58"><a href="#cb1-58"></a>  <span class="dt">image =</span> <span class="st">'input_image.img'</span>,</span>
<span id="cb1-59"><a href="#cb1-59"></a>  <span class="dt">groundTruth =</span> <span class="st">'input_groundtruth.shp'</span>,</span>
<span id="cb1-60"><a href="#cb1-60"></a>  <span class="dt">groundTruthValues =</span> <span class="kw">list</span>(<span class="st">'roof'</span> =<span class="st"> </span><span class="dv">1</span>, </span>
<span id="cb1-61"><a href="#cb1-61"></a>                           <span class="st">'street'</span> =<span class="st"> </span><span class="dv">2</span>,</span>
<span id="cb1-62"><a href="#cb1-62"></a>                           <span class="st">'pervious'</span> =<span class="st"> </span><span class="dv">3</span>,</span>
<span id="cb1-63"><a href="#cb1-63"></a>                           <span class="st">'shadow'</span> =<span class="st"> </span><span class="dv">4</span>,</span>
<span id="cb1-64"><a href="#cb1-64"></a>                           <span class="st">'water'</span> =<span class="st"> </span><span class="dv">5</span>),</span>
<span id="cb1-65"><a href="#cb1-65"></a>  <span class="dt">spectrSigName =</span> <span class="st">'spectrSig.Rdata'</span>,</span>
<span id="cb1-66"><a href="#cb1-66"></a>  <span class="dt">modelName =</span> <span class="st">'rForest.Rdata'</span>,</span>
<span id="cb1-67"><a href="#cb1-67"></a>  <span class="dt">overlayExists =</span> <span class="ot">FALSE</span>,</span>
<span id="cb1-68"><a href="#cb1-68"></a>  <span class="dt">nCores =</span> parallel<span class="op">::</span><span class="kw">detectCores</span>() <span class="op">-</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb1-69"><a href="#cb1-69"></a>  <span class="dt">mtryGrd =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, </span>
<span id="cb1-70"><a href="#cb1-70"></a>  <span class="dt">ntreeGrd=</span><span class="kw">seq</span>(<span class="dv">80</span>, <span class="dv">150</span>, <span class="dt">by=</span><span class="dv">10</span>),</span>
<span id="cb1-71"><a href="#cb1-71"></a>  <span class="dt">nfolds =</span> <span class="dv">3</span>, </span>
<span id="cb1-72"><a href="#cb1-72"></a>  <span class="dt">nodesize =</span> <span class="dv">3</span>, </span>
<span id="cb1-73"><a href="#cb1-73"></a>  <span class="dt">cvrepeats =</span> <span class="dv">2</span>)</span>
<span id="cb1-74"><a href="#cb1-74"></a></span>
<span id="cb1-75"><a href="#cb1-75"></a><span class="co"># check model performance</span></span>
<span id="cb1-76"><a href="#cb1-76"></a><span class="kw">load</span>(<span class="kw">file.path</span>(paths<span class="op">$</span>gis,<span class="st">"rForest.Rdata"</span>))</span>
<span id="cb1-77"><a href="#cb1-77"></a>caret<span class="op">::</span><span class="kw">confusionMatrix</span>(<span class="dt">data =</span> model<span class="op">$</span>finalModel<span class="op">$</span>predicted, </span>
<span id="cb1-78"><a href="#cb1-78"></a>                       <span class="dt">reference =</span> model<span class="op">$</span>trainingData<span class="op">$</span>.outcome, </span>
<span id="cb1-79"><a href="#cb1-79"></a>                       <span class="dt">mode =</span> <span class="st">'prec_recall'</span>)</span>
<span id="cb1-80"><a href="#cb1-80"></a>                       </span>
<span id="cb1-81"><a href="#cb1-81"></a><span class="co"># classify image for roofs and streets</span></span>
<span id="cb1-82"><a href="#cb1-82"></a>kwb.ml<span class="op">::</span><span class="kw">predictSurfClass</span>(<span class="dt">rawdir =</span> paths<span class="op">$</span>gis,</span>
<span id="cb1-83"><a href="#cb1-83"></a>                                    <span class="dt">modelName =</span> <span class="st">'rForest.Rdata'</span>,</span>
<span id="cb1-84"><a href="#cb1-84"></a>                                    <span class="dt">image =</span> <span class="st">'input_image.img'</span>,</span>
<span id="cb1-85"><a href="#cb1-85"></a>                                    <span class="dt">predName =</span> <span class="st">'classified_image.img'</span>)</span>
<span id="cb1-86"><a href="#cb1-86"></a></span>
<span id="cb1-87"><a href="#cb1-87"></a><span class="co"># make overlay object (list where each element is a vector of the pixel values </span></span>
<span id="cb1-88"><a href="#cb1-88"></a><span class="co"># of the classified image for each subcatchment)</span></span>
<span id="cb1-89"><a href="#cb1-89"></a>urbanAnnualRunoff<span class="op">::</span><span class="kw">makeOverlay</span>(<span class="dt">rawdir =</span> paths<span class="op">$</span>gis,</span>
<span id="cb1-90"><a href="#cb1-90"></a>                               <span class="dt">rasterData =</span> <span class="st">'classified_image.img'</span>,</span>
<span id="cb1-91"><a href="#cb1-91"></a>                               <span class="dt">subcatchmSPobject =</span> abimo_org,</span>
<span id="cb1-92"><a href="#cb1-92"></a>                               <span class="dt">overlayName =</span> <span class="st">'surfType'</span>)</span>
<span id="cb1-93"><a href="#cb1-93"></a></span>
<span id="cb1-94"><a href="#cb1-94"></a><span class="co"># compute ABIMO variable STR_FLGES (m2 street area)</span></span>
<span id="cb1-95"><a href="#cb1-95"></a>abimo_org<span class="op">@</span>data<span class="op">$</span>STR_FLGES &lt;-<span class="st"> </span>urbanAnnualRunoff<span class="op">::</span><span class="kw">makeSTR_FLGES</span>(</span>
<span id="cb1-96"><a href="#cb1-96"></a>  <span class="dt">rawdir =</span> paths<span class="op">$</span>gis,</span>
<span id="cb1-97"><a href="#cb1-97"></a>  <span class="dt">subcatchmSPobject =</span> abimo_org,</span>
<span id="cb1-98"><a href="#cb1-98"></a>  <span class="dt">mask =</span> <span class="st">'input_maskUrbanCore.shp'</span>,</span>
<span id="cb1-99"><a href="#cb1-99"></a>  <span class="dt">rasterData =</span> <span class="st">'classified_image.img'</span>,</span>
<span id="cb1-100"><a href="#cb1-100"></a>  <span class="dt">overlayName =</span> <span class="st">'surfType'</span>,</span>
<span id="cb1-101"><a href="#cb1-101"></a>  <span class="dt">targetValue =</span> <span class="dv">2</span>, </span>
<span id="cb1-102"><a href="#cb1-102"></a>  <span class="dt">add_streets_outside_subcatchments =</span> <span class="ot">FALSE</span></span>
<span id="cb1-103"><a href="#cb1-103"></a>  )</span>
<span id="cb1-104"><a href="#cb1-104"></a></span>
<span id="cb1-105"><a href="#cb1-105"></a><span class="co"># make ABIMO variable FLGES</span></span>
<span id="cb1-106"><a href="#cb1-106"></a>abimo_org<span class="op">@</span>data<span class="op">$</span>FLGES &lt;-<span class="st"> </span>urbanAnnualRunoff<span class="op">::</span><span class="kw">makeFLGES</span>(<span class="dt">subcatchmSPobject =</span> abimo_org) <span class="op">-</span><span class="st"> </span>abimo_org<span class="op">@</span>data<span class="op">$</span>STR_FLGES</span>
<span id="cb1-107"><a href="#cb1-107"></a></span>
<span id="cb1-108"><a href="#cb1-108"></a><span class="co"># compute ABIMO variable VG (% soil sealing)</span></span>
<span id="cb1-109"><a href="#cb1-109"></a>abimo_org<span class="op">@</span>data<span class="op">$</span>VG &lt;-<span class="st"> </span>urbanAnnualRunoff<span class="op">::</span><span class="kw">makeVG</span>(<span class="dt">rawdir =</span> paths<span class="op">$</span>gis,</span>
<span id="cb1-110"><a href="#cb1-110"></a>                        <span class="dt">subcatchmSPobject =</span> abimo_org,</span>
<span id="cb1-111"><a href="#cb1-111"></a>                        <span class="dt">rasterData =</span> <span class="st">'input_impervious.tif'</span>,</span>
<span id="cb1-112"><a href="#cb1-112"></a>                        <span class="dt">targetValue =</span> <span class="dv">80</span>)</span>
<span id="cb1-113"><a href="#cb1-113"></a></span>
<span id="cb1-114"><a href="#cb1-114"></a></span>
<span id="cb1-115"><a href="#cb1-115"></a><span class="co"># compute ABIMO variable PROBAU (%roof)</span></span>
<span id="cb1-116"><a href="#cb1-116"></a>abimo_org<span class="op">@</span>data<span class="op">$</span>PROBAU &lt;-<span class="st"> </span>urbanAnnualRunoff<span class="op">::</span><span class="kw">makePROBAU</span>(</span>
<span id="cb1-117"><a href="#cb1-117"></a>  <span class="dt">rawdir =</span> paths<span class="op">$</span>gis,</span>
<span id="cb1-118"><a href="#cb1-118"></a>  <span class="dt">rasterData =</span> <span class="st">'classified_image.img'</span>,</span>
<span id="cb1-119"><a href="#cb1-119"></a>  <span class="dt">overlayName =</span> <span class="st">'surfType'</span>,</span>
<span id="cb1-120"><a href="#cb1-120"></a>  <span class="dt">targetValue =</span> <span class="dv">1</span>)</span>
<span id="cb1-121"><a href="#cb1-121"></a></span>
<span id="cb1-122"><a href="#cb1-122"></a><span class="co">### fix previously wrong calculated area shares (PROBAU, PROVGU, STR_FLGES)</span></span>
<span id="cb1-123"><a href="#cb1-123"></a>abimo &lt;-<span class="st"> </span>urbanAnnualRunoff<span class="op">::</span><span class="kw">fix_abimo_shares</span>(abimo_org)</span>
<span id="cb1-124"><a href="#cb1-124"></a></span>
<span id="cb1-125"><a href="#cb1-125"></a><span class="co">## Decoupling from SWMM modelling: </span></span>
<span id="cb1-126"><a href="#cb1-126"></a><span class="co">## https://kwb-r.github.io/keys.lid/articles/scenarios.html#green-roof</span></span>
<span id="cb1-127"><a href="#cb1-127"></a><span class="co">##</span></span>
<span id="cb1-128"><a href="#cb1-128"></a><span class="co"># 100 % green-roof: with_berm_intensive_no-drainmat</span></span>
<span id="cb1-129"><a href="#cb1-129"></a><span class="co">#abimo@data$PROBAU &lt;- (1-1*(90.42-15.2)/100)*abimo@data$PROBAU # combi-1_high</span></span>
<span id="cb1-130"><a href="#cb1-130"></a><span class="co"># 50 % green-roof: with_berm_intensive_no-drainmat</span></span>
<span id="cb1-131"><a href="#cb1-131"></a><span class="co">#abimo@data$PROBAU &lt;- (1-0.5*(90.42-15.2)/100)*abimo@data$PROBAU # combi-1_medium</span></span>
<span id="cb1-132"><a href="#cb1-132"></a><span class="co"># 25 % green-roof: with_berm_intensive_no-drainmat</span></span>
<span id="cb1-133"><a href="#cb1-133"></a><span class="co">#abimo@data$PROBAU &lt;- (1-0.25*(90.42-15.2)/100)*abimo@data$PROBAU # combi-1_low</span></span>
<span id="cb1-134"><a href="#cb1-134"></a><span class="co"># 100 % green-roof: with_berm_extensive_no-drainmat</span></span>
<span id="cb1-135"><a href="#cb1-135"></a><span class="co">#abimo@data$PROBAU &lt;- (1-1*(72.6-15.2)/100)*abimo@data$PROBAU # combi-2_high</span></span>
<span id="cb1-136"><a href="#cb1-136"></a><span class="co"># 50 % green-roof: with_berm_extensive_no-drainmat</span></span>
<span id="cb1-137"><a href="#cb1-137"></a><span class="co">#abimo@data$PROBAU &lt;- (1-0.5*(72.6-15.2)/100)*abimo@data$PROBAU # combi-2_medium</span></span>
<span id="cb1-138"><a href="#cb1-138"></a><span class="co"># 25 % green-roof: with_berm_extensive_no-drainmat</span></span>
<span id="cb1-139"><a href="#cb1-139"></a><span class="co">#abimo@data$PROBAU &lt;- (1-0.25*(72.6-15.2)/100)*abimo@data$PROBAU # combi-2_low</span></span>
<span id="cb1-140"><a href="#cb1-140"></a></span>
<span id="cb1-141"><a href="#cb1-141"></a></span>
<span id="cb1-142"><a href="#cb1-142"></a><span class="co">## Decoupling from SWMM modelling: </span></span>
<span id="cb1-143"><a href="#cb1-143"></a><span class="co">## https://kwb-r.github.io/keys.lid/articles/scenarios.html#permeable-pavements</span></span>
<span id="cb1-144"><a href="#cb1-144"></a><span class="co">## provgu &lt;- abimo@data$PROVGU</span></span>
<span id="cb1-145"><a href="#cb1-145"></a><span class="co">## abimo@data$PROVGU &lt;- provgu</span></span>
<span id="cb1-146"><a href="#cb1-146"></a><span class="co"># 100 % permeable pavements: 180mm.per.hour_no-drainage</span></span>
<span id="cb1-147"><a href="#cb1-147"></a><span class="co">#abimo@data$PROVGU &lt;- (1-100*(0.572-0.152)/50)*abimo@data$PROVGU # combi_high</span></span>
<span id="cb1-148"><a href="#cb1-148"></a><span class="co">#  50 % permeable pavements: 180mm.per.hour_no-drainage</span></span>
<span id="cb1-149"><a href="#cb1-149"></a><span class="co">#abimo@data$PROVGU &lt;- (1-50*(0.572-0.152)/50)*abimo@data$PROVGU # combi_medium</span></span>
<span id="cb1-150"><a href="#cb1-150"></a><span class="co">#  25 % permeable pavements: 180mm.per.hour_no-drainage</span></span>
<span id="cb1-151"><a href="#cb1-151"></a><span class="co">#abimo@data$PROVGU &lt;- (1-25*(0.572-0.152)/50)*abimo@data$PROVGU # combi_low</span></span>
<span id="cb1-152"><a href="#cb1-152"></a><span class="co">#  10 % permeable pavements: 180mm.per.hour_no-drainage</span></span>
<span id="cb1-153"><a href="#cb1-153"></a><span class="co">#abimo@data$PROVGU &lt;- (1-10*(0.572-0.152)/50)*abimo@data$PROVGU </span></span>
<span id="cb1-154"><a href="#cb1-154"></a></span>
<span id="cb1-155"><a href="#cb1-155"></a><span class="co"># use raw code to compute and assign remaining ABIMO variables manually</span></span>
<span id="cb1-156"><a href="#cb1-156"></a></span>
<span id="cb1-157"><a href="#cb1-157"></a><span class="co">### use Berlin Abimo data (for 'Blockteilflaechen' connected to channelisation </span><span class="al">###</span><span class="co"> to imrpove default parameterisation for 'unkown' underground types in Beijing </span></span>
<span id="cb1-158"><a href="#cb1-158"></a>abimo_berlin &lt;-<span class="st"> </span>foreign<span class="op">::</span><span class="kw">read.dbf</span>(paths<span class="op">$</span>abimo_berlin) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1-159"><a href="#cb1-159"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(KANAL <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb1-160"><a href="#cb1-160"></a></span>
<span id="cb1-161"><a href="#cb1-161"></a>share_vg_str &lt;-<span class="st"> </span><span class="kw">colSums</span>(abimo_berlin[, stringr<span class="op">::</span><span class="kw">str_detect</span>(<span class="kw">names</span>(abimo_berlin), <span class="st">"^VGSTRASSE"</span>), <span class="dt">drop =</span> <span class="ot">FALSE</span>] <span class="op">*</span><span class="st"> </span>abimo_berlin<span class="op">$</span>STR_FLGES <span class="op">/</span><span class="kw">sum</span>(abimo_berlin<span class="op">$</span>STR_FLGES))</span>
<span id="cb1-162"><a href="#cb1-162"></a>                       </span>
<span id="cb1-163"><a href="#cb1-163"></a>share_belag &lt;-<span class="st"> </span><span class="kw">colSums</span>(abimo_berlin[, stringr<span class="op">::</span><span class="kw">str_detect</span>(<span class="kw">names</span>(abimo_berlin), <span class="st">"^BELAG"</span>)] <span class="op">*</span><span class="st"> </span>abimo_berlin<span class="op">$</span>FLGES <span class="op">/</span><span class="kw">sum</span>(abimo_berlin<span class="op">$</span>FLGES))</span>
<span id="cb1-164"><a href="#cb1-164"></a>share_belag &lt;-<span class="st"> </span>share_belag<span class="op">*</span><span class="dv">100</span><span class="op">/</span><span class="kw">sum</span>(share_belag)</span>
<span id="cb1-165"><a href="#cb1-165"></a></span>
<span id="cb1-166"><a href="#cb1-166"></a>share_belag_str &lt;-<span class="st"> </span><span class="kw">colSums</span>(abimo_berlin[, stringr<span class="op">::</span><span class="kw">str_detect</span>(<span class="kw">names</span>(abimo_berlin), <span class="st">"^STR_BELAG"</span>)] <span class="op">*</span><span class="st"> </span>abimo_berlin<span class="op">$</span>STR_FLGES <span class="op">/</span><span class="kw">sum</span>(abimo_berlin<span class="op">$</span>STR_FLGES))</span>
<span id="cb1-167"><a href="#cb1-167"></a>share_belag_str &lt;-<span class="st"> </span>share_belag_str<span class="op">*</span><span class="dv">100</span><span class="op">/</span><span class="kw">sum</span>(share_belag_str)</span>
<span id="cb1-168"><a href="#cb1-168"></a></span>
<span id="cb1-169"><a href="#cb1-169"></a>share_kan &lt;-<span class="st"> </span><span class="kw">colSums</span>(abimo_berlin[, stringr<span class="op">::</span><span class="kw">str_detect</span>(<span class="kw">names</span>(abimo_berlin), <span class="st">"^KAN_"</span>)] <span class="op">*</span><span class="st"> </span>(abimo_berlin<span class="op">$</span>FLGES<span class="op">+</span>abimo_berlin<span class="op">$</span>STR_FLGES) <span class="op">/</span><span class="kw">sum</span>(abimo_berlin<span class="op">$</span>FLGES<span class="op">+</span>abimo_berlin<span class="op">$</span>STR_FLGES))</span>
<span id="cb1-170"><a href="#cb1-170"></a></span>
<span id="cb1-171"><a href="#cb1-171"></a><span class="co"># % imperviousness streets</span></span>
<span id="cb1-172"><a href="#cb1-172"></a>abimo<span class="op">@</span>data<span class="op">$</span>VGSTRASSE &lt;-<span class="st"> </span>share_vg_str <span class="co">#100 -&gt; 90.0402</span></span>
<span id="cb1-173"><a href="#cb1-173"></a></span>
<span id="cb1-174"><a href="#cb1-174"></a><span class="co">## Decoupling from SWMM modelling: </span></span>
<span id="cb1-175"><a href="#cb1-175"></a><span class="co">## https://kwb-r.github.io/keys.lid/articles/scenarios.html#bioretention-cell</span></span>
<span id="cb1-176"><a href="#cb1-176"></a><span class="co">## scenario: 3.6mm.per.h_mulde_no-drainage</span></span>
<span id="cb1-177"><a href="#cb1-177"></a></span>
<span id="cb1-178"><a href="#cb1-178"></a><span class="co"># 40 % of street area (unsealed area used as bioretention-cell)</span></span>
<span id="cb1-179"><a href="#cb1-179"></a><span class="co">#abimo@data$VGSTRASSE &lt;- round(abimo@data$VGSTRASSE - 40*(57.2-15.2)/50,1) #56.4 # combi_high</span></span>
<span id="cb1-180"><a href="#cb1-180"></a><span class="co"># 20 % of street area (unsealed area used as bioretention-cell)</span></span>
<span id="cb1-181"><a href="#cb1-181"></a><span class="co">#abimo@data$VGSTRASSE &lt;- round(abimo@data$VGSTRASSE - 20*(57.2-15.2)/50,1) #73.2 # combi_medium</span></span>
<span id="cb1-182"><a href="#cb1-182"></a><span class="co"># 10 % of street area (unsealed area used as bioretention-cell)</span></span>
<span id="cb1-183"><a href="#cb1-183"></a><span class="co">#abimo@data$VGSTRASSE &lt;- round(abimo@data$VGSTRASSE - 10*(57.2-15.2)/50,1) #81.6 # combi_low</span></span>
<span id="cb1-184"><a href="#cb1-184"></a><span class="co">#  5 % of street area (unsealed area used as bioretention-cell)</span></span>
<span id="cb1-185"><a href="#cb1-185"></a><span class="co">#abimo@data$VGSTRASSE &lt;- round(abimo@data$VGSTRASSE - 5*(57.2-15.2)/50,1) #85.8</span></span>
<span id="cb1-186"><a href="#cb1-186"></a></span>
<span id="cb1-187"><a href="#cb1-187"></a><span class="co"># %cover types in other imperv. areas (PROVGU)</span></span>
<span id="cb1-188"><a href="#cb1-188"></a>abimo<span class="op">@</span>data<span class="op">$</span>BELAG1 &lt;-<span class="st"> </span>share_belag[<span class="dv">1</span>] <span class="co">#100 -&gt; 34.69844</span></span>
<span id="cb1-189"><a href="#cb1-189"></a>abimo<span class="op">@</span>data<span class="op">$</span>BELAG2 &lt;-<span class="st"> </span>share_belag[<span class="dv">2</span>] <span class="co">#  0 -&gt; 48.03494</span></span>
<span id="cb1-190"><a href="#cb1-190"></a>abimo<span class="op">@</span>data<span class="op">$</span>BELAG3 &lt;-<span class="st"> </span>share_belag[<span class="dv">3</span>] <span class="co">#  0 -&gt;  5.54433</span></span>
<span id="cb1-191"><a href="#cb1-191"></a>abimo<span class="op">@</span>data<span class="op">$</span>BELAG4 &lt;-<span class="st"> </span>share_belag[<span class="dv">4</span>] <span class="co">#  0 -&gt; 11.72229</span></span>
<span id="cb1-192"><a href="#cb1-192"></a></span>
<span id="cb1-193"><a href="#cb1-193"></a><span class="co"># %cover types in street areas</span></span>
<span id="cb1-194"><a href="#cb1-194"></a>abimo<span class="op">@</span>data<span class="op">$</span>STR_BELAG1 &lt;-<span class="st"> </span>share_belag_str[<span class="dv">1</span>] <span class="co">#100 -&gt; 51.344865</span></span>
<span id="cb1-195"><a href="#cb1-195"></a>abimo<span class="op">@</span>data<span class="op">$</span>STR_BELAG2 &lt;-<span class="st"> </span>share_belag_str[<span class="dv">2</span>] <span class="co">#0 -&gt; 26.501014</span></span>
<span id="cb1-196"><a href="#cb1-196"></a>abimo<span class="op">@</span>data<span class="op">$</span>STR_BELAG3 &lt;-<span class="st"> </span>share_belag_str[<span class="dv">3</span>] <span class="co">#0 -&gt; 14.497974</span></span>
<span id="cb1-197"><a href="#cb1-197"></a>abimo<span class="op">@</span>data<span class="op">$</span>STR_BELAG4 &lt;-<span class="st"> </span>share_belag_str[<span class="dv">4</span>] <span class="co">#0 -&gt;  7.656147</span></span>
<span id="cb1-198"><a href="#cb1-198"></a></span>
<span id="cb1-199"><a href="#cb1-199"></a><span class="co"># identifiers</span></span>
<span id="cb1-200"><a href="#cb1-200"></a>abimo<span class="op">@</span>data<span class="op">$</span>BEZIRK &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb1-201"><a href="#cb1-201"></a>abimo<span class="op">@</span>data<span class="op">$</span>STAGEB &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb1-202"><a href="#cb1-202"></a>abimo<span class="op">@</span>data<span class="op">$</span>BLOCK &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb1-203"><a href="#cb1-203"></a>abimo<span class="op">@</span>data<span class="op">$</span>TEILBLOCK &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb1-204"><a href="#cb1-204"></a>abimo<span class="op">@</span>data<span class="op">$</span>NUTZUNG &lt;-<span class="st"> </span><span class="dv">21</span></span>
<span id="cb1-205"><a href="#cb1-205"></a>abimo<span class="op">@</span>data<span class="op">$</span>TYP &lt;-<span class="st"> </span><span class="dv">21</span></span>
<span id="cb1-206"><a href="#cb1-206"></a></span>
<span id="cb1-207"><a href="#cb1-207"></a></span>
<span id="cb1-208"><a href="#cb1-208"></a><span class="co"># channelization degrees. these are set manually since there is no data</span></span>
<span id="cb1-209"><a href="#cb1-209"></a>abimo<span class="op">@</span>data<span class="op">$</span>KANAL &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb1-210"><a href="#cb1-210"></a>abimo<span class="op">@</span>data<span class="op">$</span>KAN_BEB &lt;-<span class="st"> </span><span class="dv">80</span></span>
<span id="cb1-211"><a href="#cb1-211"></a>abimo<span class="op">@</span>data<span class="op">$</span>KAN_VGU &lt;-<span class="st"> </span><span class="dv">80</span></span>
<span id="cb1-212"><a href="#cb1-212"></a>abimo<span class="op">@</span>data<span class="op">$</span>KAN_STR &lt;-<span class="st"> </span><span class="dv">80</span></span>
<span id="cb1-213"><a href="#cb1-213"></a></span>
<span id="cb1-214"><a href="#cb1-214"></a><span class="co"># soil field capacity and groundwater level (personal communication, Dr. Lipin Li, </span></span>
<span id="cb1-215"><a href="#cb1-215"></a><span class="co"># Harbin Inst. of Technology)</span></span>
<span id="cb1-216"><a href="#cb1-216"></a>abimo<span class="op">@</span>data<span class="op">$</span>FELD_<span class="dv">30</span> &lt;-<span class="st"> </span><span class="dv">30</span></span>
<span id="cb1-217"><a href="#cb1-217"></a>abimo<span class="op">@</span>data<span class="op">$</span>FELD_<span class="dv">150</span> &lt;-<span class="st"> </span><span class="dv">30</span></span>
<span id="cb1-218"><a href="#cb1-218"></a>abimo<span class="op">@</span>data<span class="op">$</span>FLUR &lt;-<span class="st"> </span><span class="fl">1.17</span></span>
<span id="cb1-219"><a href="#cb1-219"></a></span>
<span id="cb1-220"><a href="#cb1-220"></a><span class="co"># compute annual and summer rainfall. </span></span>
<span id="cb1-221"><a href="#cb1-221"></a><span class="co"># *** potential enhancement: ***</span></span>
<span id="cb1-222"><a href="#cb1-222"></a><span class="co"># return the multiannual average annual rainfall. care must be taken to exclude</span></span>
<span id="cb1-223"><a href="#cb1-223"></a><span class="co"># incomplete years from the average calculation. same for summer rainfall</span></span>
<span id="cb1-224"><a href="#cb1-224"></a>precipitation &lt;-<span class="st"> </span>urbanAnnualRunoff<span class="op">::</span><span class="kw">computeABIMOclimate</span>(</span>
<span id="cb1-225"><a href="#cb1-225"></a>  <span class="dt">rawdir =</span> paths<span class="op">$</span>climate,</span>
<span id="cb1-226"><a href="#cb1-226"></a>  <span class="dt">file_inp =</span> <span class="kw">sprintf</span>(<span class="st">'raw_climateeng_precipitation_daily_%s.txt'</span>, </span>
<span id="cb1-227"><a href="#cb1-227"></a>                     paths<span class="op">$</span>site),</span>
<span id="cb1-228"><a href="#cb1-228"></a>  <span class="dt">file_out =</span> <span class="st">'precipitation.txt'</span>,</span>
<span id="cb1-229"><a href="#cb1-229"></a>  <span class="dt">summer_month_start =</span> <span class="dv">4</span>)</span>
<span id="cb1-230"><a href="#cb1-230"></a><span class="co"># compute annual and summer ETP. this goes manually into the ABIMO config file</span></span>
<span id="cb1-231"><a href="#cb1-231"></a>  evapotranspiration &lt;-<span class="st"> </span>urbanAnnualRunoff<span class="op">::</span><span class="kw">computeABIMOclimate</span>(</span>
<span id="cb1-232"><a href="#cb1-232"></a>  <span class="dt">rawdir =</span> paths<span class="op">$</span>climate,</span>
<span id="cb1-233"><a href="#cb1-233"></a>  <span class="dt">file_inp =</span> <span class="kw">sprintf</span>(<span class="st">'raw_climateeng_etp_daily_%s.txt'</span>, </span>
<span id="cb1-234"><a href="#cb1-234"></a>                     paths<span class="op">$</span>site),</span>
<span id="cb1-235"><a href="#cb1-235"></a>  <span class="dt">file_out =</span> <span class="st">'evapotranspiration.txt'</span>,</span>
<span id="cb1-236"><a href="#cb1-236"></a>  <span class="dt">summer_month_start =</span> <span class="dv">4</span>)</span>
<span id="cb1-237"><a href="#cb1-237"></a>  </span>
<span id="cb1-238"><a href="#cb1-238"></a><span class="co">### Merge complete years (i.e. 2014-2019 for Jinxi)</span></span>
<span id="cb1-239"><a href="#cb1-239"></a><span class="co">### mean rainfall: 1744mm</span></span>
<span id="cb1-240"><a href="#cb1-240"></a>climate_data &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">inner_join</span>(precipitation, evapotranspiration,</span>
<span id="cb1-241"><a href="#cb1-241"></a>                                  <span class="dt">by =</span> <span class="st">"year"</span>, </span>
<span id="cb1-242"><a href="#cb1-242"></a>                                  <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">".p"</span>, <span class="st">".etp"</span>)) <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb1-243"><a href="#cb1-243"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(dplyr<span class="op">::</span><span class="kw">across</span>(tidyselect<span class="op">::</span><span class="kw">ends_with</span>(<span class="st">"p"</span>), round))</span>
<span id="cb1-244"><a href="#cb1-244"></a></span>
<span id="cb1-245"><a href="#cb1-245"></a>climate_data_mean &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">bind_cols</span>(tibble<span class="op">::</span><span class="kw">tibble</span>(<span class="dt">time_period =</span> <span class="st">"2015-2019"</span>), </span>
<span id="cb1-246"><a href="#cb1-246"></a>                                      climate_data <span class="op">%&gt;%</span><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">summarise</span>(</span>
<span id="cb1-247"><a href="#cb1-247"></a>                                        dplyr<span class="op">::</span><span class="kw">across</span>(<span class="dt">.cols =</span> tidyselect<span class="op">::</span><span class="kw">starts_with</span>(<span class="st">"sum"</span>), </span>
<span id="cb1-248"><a href="#cb1-248"></a>                                                      <span class="dt">.fns =</span> mean)))</span>
<span id="cb1-249"><a href="#cb1-249"></a>openxlsx<span class="op">::</span><span class="kw">write.xlsx</span>(climate_data_mean, <span class="st">"climate_data_mean.xlsx"</span>)</span>
<span id="cb1-250"><a href="#cb1-250"></a></span>
<span id="cb1-251"><a href="#cb1-251"></a><span class="co">#wet year 2320mm (2016)</span></span>
<span id="cb1-252"><a href="#cb1-252"></a><span class="co">#climate_data &lt;- climate_data %&gt;%  dplyr::filter(year == "2016")</span></span>
<span id="cb1-253"><a href="#cb1-253"></a></span>
<span id="cb1-254"><a href="#cb1-254"></a><span class="co">#dry year 1407mm (2019)</span></span>
<span id="cb1-255"><a href="#cb1-255"></a><span class="co">#climate_data &lt;- climate_data %&gt;%  dplyr::filter(year == "2019")</span></span>
<span id="cb1-256"><a href="#cb1-256"></a></span>
<span id="cb1-257"><a href="#cb1-257"></a><span class="co"># annual rainfall (this can be automatized by making 'computeABIMOclimate'</span></span>
<span id="cb1-258"><a href="#cb1-258"></a><span class="co"># return the multiannual average annual rainfall. care must be taken to exclude</span></span>
<span id="cb1-259"><a href="#cb1-259"></a><span class="co"># incomplete years from the average calculation)</span></span>
<span id="cb1-260"><a href="#cb1-260"></a>round_mean &lt;-<span class="st"> </span><span class="cf">function</span>(values) {</span>
<span id="cb1-261"><a href="#cb1-261"></a>  <span class="kw">round</span>(<span class="kw">mean</span>(values), <span class="dt">digits  =</span> <span class="dv">0</span>)</span>
<span id="cb1-262"><a href="#cb1-262"></a>}</span>
<span id="cb1-263"><a href="#cb1-263"></a></span>
<span id="cb1-264"><a href="#cb1-264"></a><span class="co">### Mean precipitation value for period 2014-2019</span></span>
<span id="cb1-265"><a href="#cb1-265"></a>abimo<span class="op">@</span>data<span class="op">$</span>REGENJA &lt;-<span class="st"> </span><span class="kw">round_mean</span>(climate_data<span class="op">$</span>sum_annual.p)</span>
<span id="cb1-266"><a href="#cb1-266"></a>abimo<span class="op">@</span>data<span class="op">$</span>REGENSO &lt;-<span class="st"> </span><span class="kw">round_mean</span>(climate_data<span class="op">$</span>sum_summer.p)</span>
<span id="cb1-267"><a href="#cb1-267"></a></span>
<span id="cb1-268"><a href="#cb1-268"></a><span class="co">### Mean evapotranspiration value for period 2014-2019</span></span>
<span id="cb1-269"><a href="#cb1-269"></a>kwb.abimo<span class="op">::</span><span class="kw">abimo_xml_evap</span>(</span>
<span id="cb1-270"><a href="#cb1-270"></a>  <span class="dt">file_in =</span> paths<span class="op">$</span>abimo_config_original,</span>
<span id="cb1-271"><a href="#cb1-271"></a>  <span class="dt">file_out =</span> paths<span class="op">$</span>abimo_config_modified,</span>
<span id="cb1-272"><a href="#cb1-272"></a>  <span class="dt">evap_annual =</span> <span class="kw">round_mean</span>(climate_data<span class="op">$</span>sum_annual.etp),</span>
<span id="cb1-273"><a href="#cb1-273"></a>  <span class="dt">evap_summer =</span> <span class="kw">round_mean</span>(climate_data<span class="op">$</span>sum_summer.etp)</span>
<span id="cb1-274"><a href="#cb1-274"></a>)</span>
<span id="cb1-275"><a href="#cb1-275"></a></span>
<span id="cb1-276"><a href="#cb1-276"></a><span class="co">### Check modified ABIMO config.xml</span></span>
<span id="cb1-277"><a href="#cb1-277"></a>kwb.utils<span class="op">::</span><span class="kw">hsOpenWindowsExplorer</span>(paths<span class="op">$</span>abimo_config_modified)</span>
<span id="cb1-278"><a href="#cb1-278"></a></span>
<span id="cb1-279"><a href="#cb1-279"></a><span class="co"># select required columns and write out new shapefile</span></span>
<span id="cb1-280"><a href="#cb1-280"></a>requiredCols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'CODE'</span>, <span class="st">'BEZIRK'</span>, <span class="st">'STAGEB'</span>, <span class="st">'BLOCK'</span>, </span>
<span id="cb1-281"><a href="#cb1-281"></a>                  <span class="st">'TEILBLOCK'</span>, <span class="st">'NUTZUNG'</span>, <span class="st">'TYP'</span>, <span class="st">'FLGES'</span>, </span>
<span id="cb1-282"><a href="#cb1-282"></a>                  <span class="st">'STR_FLGES'</span>, <span class="st">'PROBAU'</span>, <span class="st">'PROVGU'</span>, <span class="st">'VGSTRASSE'</span>,</span>
<span id="cb1-283"><a href="#cb1-283"></a>                  <span class="st">'BELAG1'</span>, <span class="st">'BELAG2'</span>, <span class="st">'BELAG3'</span>, <span class="st">'BELAG4'</span>,</span>
<span id="cb1-284"><a href="#cb1-284"></a>                  <span class="st">'STR_BELAG1'</span>, <span class="st">'STR_BELAG2'</span>, <span class="st">'STR_BELAG3'</span>, <span class="st">'STR_BELAG4'</span>,</span>
<span id="cb1-285"><a href="#cb1-285"></a>                  <span class="st">'KAN_BEB'</span>, <span class="st">'KAN_VGU'</span>, <span class="st">'KAN_STR'</span>,</span>
<span id="cb1-286"><a href="#cb1-286"></a>                  <span class="st">'REGENJA'</span>, <span class="st">'REGENSO'</span>,</span>
<span id="cb1-287"><a href="#cb1-287"></a>                  <span class="st">'FELD_30'</span>, <span class="st">'FELD_150'</span>, <span class="st">'FLUR'</span>)</span>
<span id="cb1-288"><a href="#cb1-288"></a>abimo<span class="op">@</span>data &lt;-<span class="st"> </span>kwb.utils<span class="op">::</span><span class="kw">selectColumns</span>(abimo<span class="op">@</span>data, </span>
<span id="cb1-289"><a href="#cb1-289"></a>                                       <span class="dt">columns =</span> requiredCols)</span>
<span id="cb1-290"><a href="#cb1-290"></a></span>
<span id="cb1-291"><a href="#cb1-291"></a><span class="co"># format numbers to 0 decimal places (avoid 'pseudo-accuracy')</span></span>
<span id="cb1-292"><a href="#cb1-292"></a><span class="co">#abimo@data[, 8:ncol(abimo@data)] &lt;- round(</span></span>
<span id="cb1-293"><a href="#cb1-293"></a><span class="co">#  abimo@data[, 8:ncol(abimo@data)],</span></span>
<span id="cb1-294"><a href="#cb1-294"></a><span class="co">#  digits = 0)</span></span>
<span id="cb1-295"><a href="#cb1-295"></a></span>
<span id="cb1-296"><a href="#cb1-296"></a><span class="co"># change decimal separator to comma</span></span>
<span id="cb1-297"><a href="#cb1-297"></a><span class="co"># (ABIMO does not run correctly otherwise) </span></span>
<span id="cb1-298"><a href="#cb1-298"></a>abimo<span class="op">@</span>data &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">apply</span>(<span class="dt">X=</span><span class="kw">apply</span>(<span class="dt">X=</span>abimo<span class="op">@</span>data,</span>
<span id="cb1-299"><a href="#cb1-299"></a>                                         <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb1-300"><a href="#cb1-300"></a>                                         <span class="dt">FUN=</span>as.character),</span>
<span id="cb1-301"><a href="#cb1-301"></a>                                 <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb1-302"><a href="#cb1-302"></a>                                 <span class="dt">FUN=</span>gsub,</span>
<span id="cb1-303"><a href="#cb1-303"></a>                                 <span class="dt">pattern=</span><span class="st">"</span><span class="ch">\\</span><span class="st">."</span>,</span>
<span id="cb1-304"><a href="#cb1-304"></a>                                 <span class="dt">replacement=</span><span class="st">","</span>),</span>
<span id="cb1-305"><a href="#cb1-305"></a>                           <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</span>
<span id="cb1-306"><a href="#cb1-306"></a></span>
<span id="cb1-307"><a href="#cb1-307"></a></span>
<span id="cb1-308"><a href="#cb1-308"></a></span>
<span id="cb1-309"><a href="#cb1-309"></a></span>
<span id="cb1-310"><a href="#cb1-310"></a><span class="co"># write ABIMO input table</span></span>
<span id="cb1-311"><a href="#cb1-311"></a>raster<span class="op">::</span><span class="kw">shapefile</span>(<span class="dt">x=</span>abimo, </span>
<span id="cb1-312"><a href="#cb1-312"></a>                  <span class="dt">filename=</span>paths<span class="op">$</span>abimo_inp_shp,</span>
<span id="cb1-313"><a href="#cb1-313"></a>                  <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</span>
<span id="cb1-314"><a href="#cb1-314"></a></span>
<span id="cb1-315"><a href="#cb1-315"></a></span>
<span id="cb1-316"><a href="#cb1-316"></a>kwb.abimo<span class="op">::</span><span class="kw">write.dbf.abimo</span>(abimo, </span>
<span id="cb1-317"><a href="#cb1-317"></a>                           <span class="dt">new_dbf =</span> paths<span class="op">$</span>abimo_inp_dbf)</span>
<span id="cb1-318"><a href="#cb1-318"></a></span>
<span id="cb1-319"><a href="#cb1-319"></a></span>
<span id="cb1-320"><a href="#cb1-320"></a><span class="co"># run ABIMO manually in GUI ----------------------------------------------------</span></span>
<span id="cb1-321"><a href="#cb1-321"></a>abimo_out &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">'abimo_%sout.dbf'</span>, paths<span class="op">$</span>site)</span>
<span id="cb1-322"><a href="#cb1-322"></a><span class="cf">if</span>(<span class="op">!</span>fs<span class="op">::</span><span class="kw">file_exists</span>(paths<span class="op">$</span>abimo_exe)) {</span>
<span id="cb1-323"><a href="#cb1-323"></a>  <span class="kw">stop</span>(<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">"ABIMO executale does not exist: %s</span></span>
<span id="cb1-324"><a href="#cb1-324"></a><span class="st">Please copy to this location"</span>, paths<span class="op">$</span>abimo_exe)))</span>
<span id="cb1-325"><a href="#cb1-325"></a>} <span class="cf">else</span> {</span>
<span id="cb1-326"><a href="#cb1-326"></a><span class="kw">message</span>(<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">"Run ABIMO executable manually:</span></span>
<span id="cb1-327"><a href="#cb1-327"></a><span class="st">1. Select input file: </span><span class="ch">\"</span><span class="st">%s</span><span class="ch">\"</span></span>
<span id="cb1-328"><a href="#cb1-328"></a><span class="st">2. Save it under: </span><span class="ch">\"</span><span class="st">%s</span><span class="ch">\"</span><span class="st">"</span>, </span>
<span id="cb1-329"><a href="#cb1-329"></a>                    abimo_inp_path, </span>
<span id="cb1-330"><a href="#cb1-330"></a>                    abimo_out))</span>
<span id="cb1-331"><a href="#cb1-331"></a>)</span>
<span id="cb1-332"><a href="#cb1-332"></a>      </span>
<span id="cb1-333"><a href="#cb1-333"></a>kwb.utils<span class="op">::</span><span class="kw">hsOpenWindowsExplorer</span>(paths<span class="op">$</span>abimo_exe)</span>
<span id="cb1-334"><a href="#cb1-334"></a></span>
<span id="cb1-335"><a href="#cb1-335"></a><span class="co"># postprocessing ----------------------------------------------------------------</span></span>
<span id="cb1-336"><a href="#cb1-336"></a><span class="co"># post-process ABIMO output file -&gt; join it with input shape file for </span></span>
<span id="cb1-337"><a href="#cb1-337"></a><span class="co"># visualization in GIS</span></span>
<span id="cb1-338"><a href="#cb1-338"></a></span>
<span id="cb1-339"><a href="#cb1-339"></a>scenario_results_jinxi &lt;-<span class="st"> </span>urbanAnnualRunoff<span class="op">::</span><span class="kw">get_scenario_results</span>(paths)</span>
<span id="cb1-340"><a href="#cb1-340"></a></span>
<span id="cb1-341"><a href="#cb1-341"></a>scenario_results_jinxi <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb1-342"><a href="#cb1-342"></a>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">!</span>tidyselect<span class="op">::</span><span class="kw">all_of</span>(<span class="kw">c</span>(<span class="st">"abimo_inpout"</span>, <span class="st">"abimo_inpout_emissions"</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1-343"><a href="#cb1-343"></a>openxlsx<span class="op">::</span><span class="kw">write.xlsx</span>(<span class="dt">file =</span> <span class="st">"scenario_results_jinxi.xlsx"</span>,</span>
<span id="cb1-344"><a href="#cb1-344"></a>                     <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</span>
<span id="cb1-345"><a href="#cb1-345"></a><span class="co">#usethis::use_data(scenario_results_jinxi, overwrite = TRUE)</span></span></code></pre></div>
<div class="section level2">
<h2 id="scenario-results">Scenario Results<a class="anchor" aria-label="anchor" href="#scenario-results"></a>
</h2>
<p>Below is a summary table with the ABIMO water balance modelling results for the different <code>de-coupling</code> scenarios. Combining (<code>combi_xxx</code>) the different single measures, i.e.Â <code>bioretention cells</code> (for streets), <code>green roofs</code> (for sealed areas with buildings), and <code>permeable pavements</code> (for sealed areas without buildings/streets)) enables to satisfy the <code>VRR</code> (volume rainfall retended) goal defined for climate zone 4, i.e <code>0.70 &gt;= VRR &lt;= 0.85</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KWB-R/urbanAnnualRunoff" class="external-link">urbanAnnualRunoff</a></span><span class="op">)</span>
<span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span><span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="va"><a href="../reference/scenario_results_jinxi.html">scenario_results_jinxi</a></span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"abimo_inpout"</span>, <span class="st">"abimo_inpout_emissions"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-5221ae8a04943b6a0381" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5221ae8a04943b6a0381">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10"],["2015-2019_connection-060percent_default-berlin","2015-2019_connection-080percent_default-berlin","2015-2019_connection-080percent_default-berlin_combi-1_high","2015-2019_connection-080percent_default-berlin_combi-1_low","2015-2019_connection-080percent_default-berlin_combi-1_medium","2015-2019_connection-080percent_default-berlin_combi-2_high","2015-2019_connection-080percent_default-berlin_combi-2_low","2015-2019_connection-080percent_default-berlin_combi-2_medium","2015-2019_connection-100percent_default-berlin","2015-2019_connection-100percent_default-dummy"],[13.12,13.12,13.12,13.12,13.12,13.12,13.12,13.12,13.12,13.12],[22886357,22886357,22886357,22886357,22886357,22886357,22886357,22886357,22886357,22886357],[5146132,6861510,2153150,5683929,4507002,2907499,5872515,4884176,8576886,9804932],[13243315,11527938,15648737,12563240,13600349,15006627,12389556,13267639,9812561,8717990],[4496911,4496911,5084471,4639191,4779007,4972233,4624286,4734542,4496911,4363436],[0.775,0.7,0.906,0.752,0.803,0.873,0.743,0.787,0.625,0.572],[99305,132407,41550,109683,86972,56106,113323,94250,165509,189207],[643437,857915,269215,710679,563524,363533,734258,610683,1072394,1225940],[749034,998712,313397,827312,656007,423195,854761,710906,1248390,1427135],[282,376,118,312,247,159,322,268,470,538],[3,4,1,3,2,2,3,3,5,5],[52,69,22,58,46,29,59,49,87,99],[1101,1468,461,1216,965,622,1257,1045,1836,2098],[38,51,16,42,34,22,44,36,64,73],[333,444,139,368,291,188,380,316,555,634],[33,44,14,37,29,19,38,31,55,63],[4069,5426,1703,4495,3564,2299,4644,3862,6782,7753]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>scenario_name<\/th>\n      <th>catchment_km2<\/th>\n      <th>rainfall_cbm<\/th>\n      <th>runoff_cbm<\/th>\n      <th>infiltration_cbm<\/th>\n      <th>evapotrans_cbm<\/th>\n      <th>vrr<\/th>\n      <th>BOD.kg_yr<\/th>\n      <th>COD.kg_yr<\/th>\n      <th>TSS.kg_yr<\/th>\n      <th>Pb.kg_yr<\/th>\n      <th>Cd.kg_yr<\/th>\n      <th>Cr.kg_yr<\/th>\n      <th>Cu.kg_yr<\/th>\n      <th>Ni.kg_yr<\/th>\n      <th>Ti.kg_yr<\/th>\n      <th>Va.kg_yr<\/th>\n      <th>Zn.kg_yr<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level2">
<h2 id="land-use-classification-comparison">Land Use Classification Comparison<a class="anchor" aria-label="anchor" href="#land-use-classification-comparison"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">landuse_hit</span> <span class="op">&lt;-</span> <span class="fu">shapefiles</span><span class="fu">::</span><span class="fu">read.dbf</span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">landuse_hit</span><span class="op">)</span>
<span class="va">landuse_hit_stats</span> <span class="op">&lt;-</span> <span class="va">landuse_hit</span><span class="op">$</span><span class="va">dbf</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>landuse_name <span class="op">=</span> <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/multiSubstitute.html" class="external-link">multiSubstitute</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">landuse</span>, 
                           <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
                           <span class="st">'1'</span> <span class="op">=</span> <span class="st">"pervious"</span>,
                           <span class="st">'2'</span> <span class="op">=</span> <span class="st">"pervious"</span>,
                           <span class="st">'3'</span> <span class="op">=</span> <span class="st">"roof"</span>, 
                           <span class="st">'4'</span> <span class="op">=</span> <span class="st">"street"</span>,
                           <span class="st">'5'</span> <span class="op">=</span> <span class="st">"water"</span><span class="op">)</span>
                           <span class="op">)</span>
                <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">landuse_name</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>area_m2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_m2</span><span class="op">)</span>,
                   area_percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="va">area_m2</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">landuse_hit</span><span class="op">$</span><span class="va">dbf</span><span class="op">$</span><span class="va">area_m2</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>landuse <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">landuse_name</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">landuse</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">landuse</span>, <span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">)</span>

<span class="va">landuse_kwb</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">landuse_kwb</span><span class="op">)</span>

<span class="va">landuse_kwb_values</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/getValues.html" class="external-link">values</a></span><span class="op">(</span><span class="va">landuse_kwb</span><span class="op">)</span>
<span class="va">landuse_kwb_values_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">landuse_kwb_values</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">landuse_kwb_values</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">landuse_kwb_stats</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>landuse_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landuse_kwb_values_vector</span><span class="op">)</span>,
                                    landuse <span class="op">=</span> <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/multiSubstitute.html" class="external-link">multiSubstitute</a></span><span class="op">(</span><span class="va">landuse_id</span>,
                                                                         <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'1'</span> <span class="op">=</span> <span class="st">"roof"</span>,
                                                                              <span class="st">'2'</span> <span class="op">=</span> <span class="st">"street"</span>,
                                                                              <span class="st">'3'</span> <span class="op">=</span> <span class="st">"pervious"</span>,
                                                                              <span class="st">'4'</span> <span class="op">=</span> <span class="st">"shadow"</span>,
                                                                              <span class="st">'5'</span> <span class="op">=</span> <span class="st">"water"</span><span class="op">)</span><span class="op">)</span>,
                                    area_m2 <span class="op">=</span> <span class="va">landuse_kwb_values_vector</span>,
                                    area_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">landuse_kwb_values_vector</span><span class="op">)</span>,
                                    area_percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="va">area_m2</span><span class="op">/</span><span class="va">area_total</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">landuse</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">landuse</span>, <span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">)</span>


<span class="va">catchments_hit_abimo</span> <span class="op">&lt;-</span> <span class="fu">shapefiles</span><span class="fu">::</span><span class="fu">read.dbf</span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">catchments_hit_abimo</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">catchments_hit_abimo</span><span class="op">$</span><span class="va">dbf</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"subcatchment_name"</span>


<span class="va">landuse_authority_data</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu">read_xlsx</span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">landuse_authority</span>, 
                                            sheet <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span>
<span class="va">landuse_authority_metadata</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu">read_xlsx</span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">landuse_authority</span>, 
                                                sheet <span class="op">=</span> <span class="st">"metadata"</span><span class="op">)</span>

<span class="va">landuse_authority_stats</span> <span class="op">&lt;-</span> <span class="va">landuse_authority_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">landuse_authority_metadata</span>,
                   by <span class="op">=</span> <span class="st">"landuse_id"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">right_join</a></span><span class="op">(</span><span class="va">catchments_hit_abimo</span><span class="op">$</span><span class="va">dbf</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"subcatchment_name"</span>, <span class="st">"area_m2"</span><span class="op">)</span><span class="op">]</span>,
                   by <span class="op">=</span> <span class="st">"subcatchment_name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">landuse_name</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_m2</span> <span class="op">*</span> <span class="va">.data</span><span class="op">$</span><span class="va">percent</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">catchments_hit_abimo</span><span class="op">$</span><span class="va">dbf</span><span class="op">$</span><span class="va">area_m2</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>landuse_name <span class="op">=</span> <span class="fu">kwb.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kwb.utils/man/multiSubstitute.html" class="external-link">multiSubstitute</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">landuse_name</span>, 
                             <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'greenland'</span> <span class="op">=</span> <span class="st">"pervious"</span>,
                                  <span class="st">'road'</span> <span class="op">=</span> <span class="st">"streets"</span>
                                  <span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">landuse_name</span><span class="op">)</span>


<span class="fu">openxlsx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/write.xlsx.html" class="external-link">write.xlsx</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>landuse_hit_stats <span class="op">=</span> <span class="va">landuse_hit_stats</span>,
                          landuse_kwb_stats <span class="op">=</span> <span class="va">landuse_kwb_stats</span>,
                          landuse_authority_stats <span class="op">=</span> <span class="va">landuse_authority_stats</span> <span class="op">)</span>,
                     file <span class="op">=</span> <span class="st">"landuse_classification_comparison.xlsx"</span>,
                     overwrite <span class="op">=</span> <span class="cn">TRUE</span>
                     <span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="abimo-vs-swmm-comparison">ABIMO vs SWMM Comparison<a class="anchor" aria-label="anchor" href="#abimo-vs-swmm-comparison"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">swmm_annualrunoff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">swmm_annualrunoff</span>,  
                                sep <span class="op">=</span> <span class="st">""</span>, 
                                skip <span class="op">=</span> <span class="fl">9</span>, 
                                header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>


<span class="va">catchments_hit_abimo_connected_100</span> <span class="op">&lt;-</span> <span class="va">catchments_hit_abimo</span><span class="op">$</span><span class="va">dbf</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"subcatchment_name"</span>, <span class="st">"area_m2"</span>, <span class="st">"connection"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">connection</span> <span class="op">==</span> <span class="fl">100</span><span class="op">)</span>


<span class="va">catchments_hit_abimo_connected_0</span> <span class="op">&lt;-</span> <span class="va">catchments_hit_abimo</span><span class="op">$</span><span class="va">dbf</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"subcatchment_name"</span>, <span class="st">"area_m2"</span>, <span class="st">"connection"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">connection</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>

<span class="va">swmm_catchment_abimo</span> <span class="op">&lt;-</span> <span class="va">catchments_hit_abimo_connected_100</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">#catchments_hit_abimo$dbf[,c("subcatchment_name", "area_m2")] </span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>area_percent <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">area_m2</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_m2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">swmm_annualrunoff</span>, by <span class="op">=</span> <span class="st">"subcatchment_name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>area_m2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_m2</span><span class="op">)</span>,
                   total_precip_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">total_precip_mm</span><span class="op">)</span>,
                   total_evap_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">total_evap_mm</span><span class="op">)</span>,
                   total_infil_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">total_infil_mm</span><span class="op">)</span>,
                   total_runoff_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">total_runoff_mm</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>vrr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">total_runoff_mm</span><span class="op">/</span><span class="va">total_precip_mm</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="va">catchments_hit_all</span> <span class="op">&lt;-</span> <span class="fu">shapefiles</span><span class="fu">::</span><span class="fu">read.dbf</span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">catchments_hit_all</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">catchments_hit_all</span><span class="op">$</span><span class="va">dbf</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"subcatchment_name"</span>

<span class="va">swmm_catchment_all</span> <span class="op">&lt;-</span> <span class="va">catchments_hit_all</span><span class="op">$</span><span class="va">dbf</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"subcatchment_name"</span>, <span class="st">"area_m2"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>area_percent <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">area_m2</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">catchments_hit_all</span><span class="op">$</span><span class="va">dbf</span><span class="op">$</span><span class="va">area_m2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">swmm_annualrunoff</span>, by <span class="op">=</span> <span class="st">"subcatchment_name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>total_precip_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">total_precip_mm</span><span class="op">)</span>,
                   total_evap_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">total_evap_mm</span><span class="op">)</span>,
                   total_infil_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">total_infil_mm</span><span class="op">)</span>,
                   total_runoff_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">total_runoff_mm</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>vrr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">total_runoff_mm</span><span class="op">/</span><span class="va">total_precip_mm</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>


<span class="va">swmm_catchment_stats</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>catchment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"all"</span>, <span class="st">"abimo"</span><span class="op">)</span><span class="op">)</span>,
                                         <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">swmm_catchment_all</span>, 
                                                      <span class="va">swmm_catchment_abimo</span><span class="op">)</span>
                                         <span class="op">)</span>

<span class="va">sewer_connection</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu">read_xls</span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">sewer_connection</span><span class="op">)</span>
<span class="va">sewer_connection_stats_abimo</span> <span class="op">&lt;-</span> <span class="va">catchments_hit_abimo</span><span class="op">$</span><span class="va">dbf</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>area_percent <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">area_m2</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">catchments_hit_abimo</span><span class="op">$</span><span class="va">dbf</span><span class="op">$</span><span class="va">area_m2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">sewer_connection</span>, by <span class="op">=</span> <span class="st">"subcatchment_name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>connection_percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">connect</span><span class="op">)</span><span class="op">)</span>


<span class="va">sewer_connection_stats_all</span> <span class="op">&lt;-</span> <span class="va">catchments_hit_all</span><span class="op">$</span><span class="va">dbf</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>area_percent <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">area_m2</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">catchments_hit_all</span><span class="op">$</span><span class="va">dbf</span><span class="op">$</span><span class="va">area_m2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">sewer_connection</span>, by <span class="op">=</span> <span class="st">"subcatchment_name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>connection_percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">area_percent</span><span class="op">*</span><span class="va">.data</span><span class="op">$</span><span class="va">connect</span><span class="op">)</span><span class="op">)</span>

<span class="va">sewer_connection_stats</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>catchment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"all"</span>, <span class="st">"abimo"</span><span class="op">)</span><span class="op">)</span>,
                                         <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">sewer_connection_stats_all</span>, 
                                                      <span class="va">sewer_connection_stats_abimo</span><span class="op">)</span>
                                         <span class="op">)</span>


<span class="fu">urbanAnnualRunoff</span><span class="fu">::</span><span class="fu"><a href="../reference/read_concentrations.html">read_concentrations</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">emissions_input</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"VariableName"</span>, <span class="st">"mean"</span>, <span class="st">"UnitsAbbreviation"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">openxlsx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/write.xlsx.html" class="external-link">write.xlsx</a></span><span class="op">(</span><span class="st">"concentrations.xlsx"</span><span class="op">)</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/robetatis" class="external-link">Roberto Tatis-Muvdi</a>, <a href="https://mrustl.de" class="external-link">Michael Rustler</a>, <a href="https://www.kompetenz-wasser.de/en/forschung/projekte/keys" class="external-link"><img src="https://www.kompetenz-wasser.de/media/pages/forschung/projekte/keys/bb2d39dc7a-1639132760/keys-logo.png" alt="Project KEYS" height="24"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
